#!/bin/bash

APP="$1"
NAME="$2"
SOCKET="$3"
SERVICE="$4"


if [[ $SOCKET == /* ]]; then
    # echo "Checking service $SERVICE on $SOCKET"
    DC_FILE=/var/lib/controller/$NAME/docker-compose.yml
    export DOCKER_HOST=unix:///fat/docker.sock
    TARGET_CONTAINER="${APP}_${SERVICE}_1"
    until [ -S "$SOCKET" ] && [ ! -z "$(docker ps -q --filter status=running --filter name=$TARGET_CONTAINER)"  ]; do
        sleep 0.1;
    done
else
    echo "Checking for remote $SERVICE: $SOCKET"
    until $(curl --output /dev/null --silent --head --fail http://$SOCKET); do
        sleep 0.1;
    done
fi

# required for zmq publishing
echo "STARTED"
