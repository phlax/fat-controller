#!/bin/bash

readarray -t ACTIVE <<<"$(systemctl | grep 'loaded active')"
RUNNING=()

for SERVICE in "${ACTIVE[@]}"; do
    SERVICE=$(echo $SERVICE | awk '{$1=$1};1' | cut -d' ' -f1)
    SERVICE=$(echo $SERVICE | grep -E "^controller-.*.service$") || continue
    SERVICE=$(echo $SERVICE | grep -vE '\-\-proxy.service$') || continue
    RUNNING+=($SERVICE)
done

if [ ${#RUNNING[@]} -eq 0 ]; then
    exit 0;
fi

TIMEOUT=$(cat /var/lib/controller/idle-timeout)
EXPIRY=$(date --date "$TIMEOUT seconds ago" +%s)

for SERVICE in $RUNNING; do
    SERVICE=${SERVICE:11:-8}
    DC_FILE=/var/lib/controller/$SERVICE/docker-compose.yml
    TSTAMP=$(stat -c %Y "$DC_FILE");
    if [ $TSTAMP -gt $EXPIRY ]; then
        break;
    fi
    TOUCHFILES=$(grep -E "^$SERVICE " /var/lib/controller/idle-files | cut -d' ' -f2-)
    EXPIRE=1
    for TOUCH in $TOUCHFILES; do
        if [ ! -f "$TOUCH" ]; then
            continue;
        fi
        TSTAMP=$(stat -c %Y "$TOUCH");
        if [ $TSTAMP -gt $EXPIRY ]; then
            EXPIRE=
            break
        fi
    done
    if [ ! -z "$EXPIRE" ]; then
        echo "Stopping idle service: $SERVICE"
        systemctl stop controller-$SERVICE
    fi
done
